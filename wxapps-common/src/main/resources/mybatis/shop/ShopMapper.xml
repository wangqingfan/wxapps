<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.beixiao.shop.repository.ShopDao" >
  <resultMap id="BaseResultMap" type="com.beixiao.shop.domain.Shop" >
    <id column="shop_id" property="shopId" jdbcType="INTEGER" />
    <result column="mini_app_id" property="miniAppId" jdbcType="INTEGER" />
    <result column="cutomer_name" property="cutomerName" jdbcType="VARCHAR" />
    <result column="id_code" property="idCode" jdbcType="VARCHAR" />
    <result column="client_card_id" property="clientCardId" jdbcType="INTEGER" />
    <result column="shop_province" property="shopProvince" jdbcType="VARCHAR" />
    <result column="shop_city" property="shopCity" jdbcType="VARCHAR" />
    <result column="shop_sub_city" property="shopSubCity" jdbcType="VARCHAR" />
    <result column="shop_address" property="shopAddress" jdbcType="VARCHAR" />
    <result column="shop_telphone" property="shopTelphone" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="lst_mod_time" property="lstModTime" jdbcType="TIMESTAMP" />
    <result column="shop_state" property="shopState" jdbcType="TINYINT" />
    <result column="total_deal_money" property="totalDealMoney" jdbcType="DECIMAL" />
    <result column="shop_type" property="shopType" jdbcType="TINYINT" />
    <result column="product_id" property="productId" jdbcType="INTEGER" />
    <result column="shop_name" property="shopName" jdbcType="VARCHAR" />
  </resultMap>
  
  <sql id="Base_Column_List" >
    shop_id, mini_app_id, cutomer_name, id_code, client_card_id, shop_province, shop_city, 
    shop_sub_city, shop_address, shop_telphone, create_time, lst_mod_time, shop_state, 
    total_deal_money,shop_type,product_id,shop_name
  </sql>
  <select id="findById" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from shop
    where shop_id = #{shopId,jdbcType=INTEGER}
  </select>
  <delete id="deleteById" parameterType="java.lang.Integer" >
    delete from shop
    where shop_id = #{shopId,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.beixiao.shop.domain.Shop" useGeneratedKeys="true" keyProperty="shopId">
    insert into shop
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="shopId != null" >
        shop_id,
      </if>
      <if test="miniAppId != null" >
        mini_app_id,
      </if>
      <if test="cutomerName != null" >
        cutomer_name,
      </if>
      <if test="idCode != null" >
        id_code,
      </if>
      <if test="clientCardId != null" >
        client_card_id,
      </if>
      <if test="shopProvince != null" >
        shop_province,
      </if>
      <if test="shopCity != null" >
        shop_city,
      </if>
      <if test="shopSubCity != null" >
        shop_sub_city,
      </if>
      <if test="shopAddress != null" >
        shop_address,
      </if>
      <if test="shopTelphone != null" >
        shop_telphone,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="lstModTime != null" >
        lst_mod_time,
      </if>
      <if test="shopState != null" >
        shop_state,
      </if>
      <if test="totalDealMoney != null" >
        total_deal_money,
      </if>
      <if test="shopType != null" >
        shop_type,
      </if>
      <if test="productId != null" >
        product_id,
      </if>
      <if test="shopName != null" >
        shop_name,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="shopId != null" >
        #{shopId,jdbcType=INTEGER},
      </if>
      <if test="miniAppId != null" >
        #{miniAppId,jdbcType=INTEGER},
      </if>
      <if test="cutomerName != null" >
        #{cutomerName,jdbcType=VARCHAR},
      </if>
      <if test="idCode != null" >
        #{idCode,jdbcType=VARCHAR},
      </if>
      <if test="clientCardId != null" >
        #{clientCardId,jdbcType=INTEGER},
      </if>
      <if test="shopProvince != null" >
        #{shopProvince,jdbcType=VARCHAR},
      </if>
      <if test="shopCity != null" >
        #{shopCity,jdbcType=VARCHAR},
      </if>
      <if test="shopSubCity != null" >
        #{shopSubCity,jdbcType=VARCHAR},
      </if>
      <if test="shopAddress != null" >
        #{shopAddress,jdbcType=VARCHAR},
      </if>
      <if test="shopTelphone != null" >
        #{shopTelphone,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lstModTime != null" >
        #{lstModTime,jdbcType=TIMESTAMP},
      </if>
      <if test="shopState != null" >
        #{shopState,jdbcType=TINYINT},
      </if>
      <if test="totalDealMoney != null" >
        #{totalDealMoney,jdbcType=DECIMAL},
      </if>
      <if test="shopType != null" >
        #{shopType,jdbcType=TINYINT},
      </if>
      <if test="productId != null" >
        #{productId,jdbcType=INTEGER},
      </if>
      <if test="shopName != null" >
        #{shopName,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="update" parameterType="com.beixiao.shop.domain.Shop" >
    update shop
    <set >
      <if test="miniAppId != null" >
        mini_app_id = #{miniAppId,jdbcType=INTEGER},
      </if>
      <if test="cutomerName != null" >
        cutomer_name = #{cutomerName,jdbcType=VARCHAR},
      </if>
      <if test="idCode != null" >
        id_code = #{idCode,jdbcType=VARCHAR},
      </if>
      <if test="clientCardId != null" >
        client_card_id = #{clientCardId,jdbcType=INTEGER},
      </if>
      <if test="shopProvince != null" >
        shop_province = #{shopProvince,jdbcType=VARCHAR},
      </if>
      <if test="shopCity != null" >
        shop_city = #{shopCity,jdbcType=VARCHAR},
      </if>
      <if test="shopSubCity != null" >
        shop_sub_city = #{shopSubCity,jdbcType=VARCHAR},
      </if>
      <if test="shopAddress != null" >
        shop_address = #{shopAddress,jdbcType=VARCHAR},
      </if>
      <if test="shopTelphone != null" >
        shop_telphone = #{shopTelphone,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lstModTime != null" >
        lst_mod_time = #{lstModTime,jdbcType=TIMESTAMP},
      </if>
      <if test="shopState != null" >
        shop_state = #{shopState,jdbcType=TINYINT},
      </if>
      <if test="totalDealMoney != null" >
        total_deal_money = #{totalDealMoney,jdbcType=DECIMAL},
      </if>
      <if test="shopType != null" >
        shop_type = #{shopType,jdbcType=TINYINT},
      </if>
      <if test="productId != null" >
        product_id = #{productId,jdbcType=INTEGER},
      </if>
      <if test="shopName != null" >
        shop_name = #{shopName,jdbcType=VARCHAR},
      </if>
    </set>
    where shop_id = #{shopId,jdbcType=INTEGER}
  </update>
  <resultMap id="basicInfoResultMap" type="com.beixiao.shop.dto.BasicInfo" >
    <id column="shop_id" property="shopId" jdbcType="INTEGER" />
    <result column="mini_app_id" property="miniAppId" jdbcType="INTEGER" />
    <result column="cutomer_name" property="cutomerName" jdbcType="VARCHAR" />
    <result column="id_code" property="idCode" jdbcType="VARCHAR" />
    <result column="client_card_id" property="clientCardId" jdbcType="INTEGER" />
    <result column="shop_province" property="shopProvince" jdbcType="VARCHAR" />
    <result column="shop_city" property="shopCity" jdbcType="VARCHAR" />
    <result column="shop_sub_city" property="shopSubCity" jdbcType="VARCHAR" />
    <result column="shop_address" property="shopAddress" jdbcType="VARCHAR" />
    <result column="shop_telphone" property="shopTelphone" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="lst_mod_time" property="lstModTime" jdbcType="TIMESTAMP" />
    <result column="shop_state" property="shopState" jdbcType="TINYINT" />
    <result column="total_deal_money" property="totalDealMoney" jdbcType="DECIMAL" />
    <result column="shop_type" property="shopType" jdbcType="TINYINT" />
    <result column="shop_name" property="shopName" jdbcType="VARCHAR" />
    <association  property="restaurant" resultMap="restaurantResultMap"/>
    <association  property="activity" resultMap="activityResultMap"/>
    <association  property="customerCard" resultMap="customerCardMap"/>
    <association  property="bankInfo" resultMap="bankInfoMap"/>
    <association  property="miniApps" resultMap="miniAppsMap"/>
  </resultMap>
  <resultMap type="com.beixiao.restaurant.domain.Restaurant" id="restaurantResultMap">
  	<id column="restaurant_id" property="restaurantId" jdbcType="INTEGER" />
    <result column="rest_least_consume" property="leastConsume" jdbcType="DECIMAL" />
    <result column="rest_delivery_distance" property="deliveryDistance" jdbcType="VARCHAR" />
    <result column="rest_begin_bussiness_time" property="beginBussinessTime" jdbcType="VARCHAR" />
    <result column="rest_end_bussiness_time" property="endBussinessTime" jdbcType="VARCHAR" />
    <result column="rest_bussiness_state" property="bussinessState" jdbcType="TINYINT" />
    <result column="rest_announcement" property="announcement" jdbcType="VARCHAR" />
    <result column="rest_create_time_str" property="createTimeStr" />
    <result column="rest_lst_mod_time_str" property="lstModTimeStr" />
    <result column="rest_shop_id" property="shopId" jdbcType="INTEGER" />
  </resultMap>
  <resultMap id="activityResultMap" type="com.beixiao.activity.domain.Activity" >
    <id column="activity_id" property="activityId" jdbcType="INTEGER" />
    <result column="act_content" property="content" jdbcType="VARCHAR" />
    <result column="act_state" property="state" jdbcType="TINYINT" />
    <result column="act_create_author_id" property="createAuthorId" jdbcType="INTEGER" />
    <result column="act_create_author_name" property="createAuthorName" jdbcType="INTEGER" />
    <result column="act_create_time_str" property="createTimeStr" jdbcType="TIMESTAMP" />
    <result column="act_lst_mod_time_str" property="lstModTimeStr" jdbcType="TIMESTAMP" />
    <result column="act_shop_id" property="shopId" jdbcType="INTEGER" />
  </resultMap>
  <resultMap id="customerCardMap" type="com.beixiao.customercard.domain.CustomerCard" >
    <id column="cc_customer_card_id" property="customerCardId" jdbcType="INTEGER" />
    <result column="cc_bank_id" property="bankId" jdbcType="INTEGER" />
    <result column="cc_card_type" property="cardType" jdbcType="TINYINT" />
    <result column="cc_card_code" property="cardCode" jdbcType="VARCHAR" />
    <result column="cc_card_customer_name" property="cardCustomerName" jdbcType="VARCHAR" />
    <result column="cc_create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="cc_lst_mdf_time" property="lstMdfTime" jdbcType="TIMESTAMP" />
    <result column="cc_bind_card" property="bindCard" jdbcType="TINYINT" />
    <result column="cc_mobile_phone" property="mobilePhone" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="bankInfoMap" type="com.beixiao.bankinfo.domain.BankInfo">
    <id column="bi_bank_id" jdbcType="INTEGER" property="bankId" />
    <result column="bi_bank_name" jdbcType="VARCHAR" property="bankName" />
    <result column="bi_p_bank_id" jdbcType="INTEGER" property="pBankId" />
    <result column="bi_country" jdbcType="VARCHAR" property="country" />
    <result column="bi_province" jdbcType="VARCHAR" property="province" />
    <result column="bi_city" jdbcType="VARCHAR" property="city" />
    <result column="bi_street" jdbcType="VARCHAR" property="street" />
    <result column="bi_bank_no" jdbcType="VARCHAR" property="bankNo" />
    <result column="bi_bank_address" jdbcType="VARCHAR" property="bankAddress" />
  </resultMap>
  <resultMap id="miniAppsMap" type="com.beixiao.system.domain.MiniApps" >
    <id column="ma_mini_app_id" property="miniAppId" jdbcType="INTEGER" />
    <result column="ma_create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="ma_app_id" property="appId" jdbcType="VARCHAR" />
    <result column="ma_app_secret" property="appSecret" jdbcType="VARCHAR" />
    <result column="ma_app_state" property="appState" jdbcType="TINYINT" />
  </resultMap>
  <select id="findBasicInfoByAppId" parameterType="java.lang.Integer" resultMap="basicInfoResultMap">
  	SELECT
		s.*,
		r.restaurant_id,
		r.least_consume as rest_least_consume,
		r.delivery_distance as rest_delivery_distance,
		r.begin_bussiness_time as rest_begin_bussiness_time,
		r.end_bussiness_time as rest_end_bussiness_time,
		r.bussiness_state as rest_bussiness_state,
		r.announcement as rest_announcement,
		DATE_FORMAT(r.create_time,'%Y-%m-%d %H:%i:%S') as rest_create_time_str,
		DATE_FORMAT(r.lst_mod_time,'%Y-%m-%d %H:%i:%S') as rest_lst_mod_time_str,
		r.shop_id as rest_shop_id,
		a.activity_id,
		a.content as act_content,
		a.state as act_state,
		a.create_author_id as act_create_author_id,
		a.create_author_name as act_create_author_name,
		DATE_FORMAT(a.create_time,'%Y-%m-%d %H:%i:%S') as act_create_time_str,
		DATE_FORMAT(a.lst_mod_time,'%Y-%m-%d %H:%i:%S') as act_lst_mod_time_str,
		a.shop_id as act_shop_id,
	FROM
		shop s
	LEFT JOIN restaurant r ON s.shop_id = r.shop_id                                                                                                                                             
	LEFT JOIN activity a ON a.shop_id = s.shop_id
	WHERE 
		s.shop_type = 1 
	AND 
		s.mini_app_id = #{value}
  </select>
  <select id="findAllPage" parameterType="java.util.Map" resultMap="BaseResultMap">
  	select 
    <include refid="Base_Column_List" />
    from shop
    <where>
    	<if test="shopId != null and shopId != 0">
    		shop_id = #{shopId}
    	</if>
    	<if test="shopName != null and shopName != '' ">
    		shop_name = #{shopName}
    	</if>
    	<if test="creatTimeStart != null and creatTimeStart != '' ">
    		create_time &gt;= #{creatTimeStart}
    	</if>
    	<if test="creatTimeEnd != null and creatTimeEnd != '' ">
    		create_time &lt;= #{creatTimeEnd}
    	</if>
    </where>
    </select>
    <select id="findBasicInfoByMap" parameterType="java.util.Map" resultMap="basicInfoResultMap">
	  	SELECT
			s.*,
			r.restaurant_id,
			r.least_consume as rest_least_consume,
			r.delivery_distance as rest_delivery_distance,
			r.begin_bussiness_time as rest_begin_bussiness_time,
			r.end_bussiness_time as rest_end_bussiness_time,
			r.bussiness_state as rest_bussiness_state,
			r.announcement as rest_announcement,
			DATE_FORMAT(r.create_time,'%Y-%m-%d %H:%i:%S') as rest_create_time_str,
			DATE_FORMAT(r.lst_mod_time,'%Y-%m-%d %H:%i:%S') as rest_lst_mod_time_str,
			r.shop_id as rest_shop_id,
			a.activity_id,
			a.content as act_content,
			a.state as act_state,
			a.create_author_id as act_create_author_id,
			a.create_author_name as act_create_author_name,
			DATE_FORMAT(a.create_time,'%Y-%m-%d %H:%i:%S') as act_create_time_str,
			DATE_FORMAT(a.lst_mod_time,'%Y-%m-%d %H:%i:%S') as act_lst_mod_time_str,
			a.shop_id as act_shop_id,
			cc.bank_id AS cc_bank_id,
			cc.customer_card_id AS cc_customer_card_id,
			cc.card_type AS cc_card_type,
			cc.card_code AS cc_card_code,
			cc.card_customer_name AS cc_card_customer_name,
			cc.bind_card AS cc_bind_card,
			cc.mobile_phone AS cc_mobile_phone,
			cc.create_time AS cc_create_time,
			cc.lst_mdf_time AS cc_lst_mdf_time,
			bi.bank_id AS bi_bank_id,
			bi.bank_name AS bi_bank_name,
			bi.p_bank_id AS bi_p_bank_id,
			bi.country AS bi_country,
			bi.province AS bi_province,
			bi.city AS bi_city,
			bi.street AS bi_street,
			bi.bank_no AS bi_bank_no,
			bi.bank_address AS bi_bank_address,
			ma.app_id AS ma_app_id
		FROM
			shop s
		LEFT JOIN restaurant r ON s.shop_id = r.shop_id                                                                                                                                             
		LEFT JOIN activity a ON a.shop_id = s.shop_id and a.state = 1
		LEFT JOIN customer_card cc ON s.client_card_id = cc.customer_card_id AND cc.bind_card = 1
		LEFT JOIN bank_info bi ON cc.bank_id = bi.bank_id 
		LEFT JOIN mini_apps ma ON s.mini_app_id = ma.mini_app_id AND ma.app_state = 1
		<where>
			<if test="shopType != null and shopType != '' ">
				and s.shop_type = #{shopType}
			</if>
			<if test="shopId != 0 and shopId != null ">
				and s.shop_id = #{shopId}
			</if>
		</where>
  </select>
  <select id="findByAppId" resultMap="BaseResultMap" parameterType="java.lang.String" >
    SELECT
		s.*
	FROM
		shop s
	LEFT JOIN mini_apps m ON s.mini_app_id = m.mini_app_id
	WHERE
		m.app_state = 1
	AND s.shop_state = 1
	AND m.app_id = #{value}
  </select>
</mapper>